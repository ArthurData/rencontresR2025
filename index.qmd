---
title: "Tester une application Shiny"
subtitle: MÃ©thodologie et outils pratiques
format: 
  thinkridentity-revealjs:
    theme: custom.scss
    slideNumber: false
chalkboard: false
author: arthurdata.github.io/rencontresR2025
include-before-body: assets/ground.html
date: last-modified
---

# Bonjour

# Il y a deux ans...

Lors des Rencontres R 2023...

## Pierrot

:::: {.columns}
::: {.column width="45%"}
::: {.fragment .fade-right}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::
:::

::: {.column width="55%"}
::: {.fragment .fade-left}
### Rencontre de Pierrot
:::

::: {.fragment .fade-left}
Il voulait refaire sa cuisine
:::

::: {.fragment .fade-left}
Il devait produire une application Shiny pour un client
:::
:::
::::

## Pierrot

:::: {.columns}
::: {.column width="45%"}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::

::: {.column width="55%"}
### Il avait alors eu une <span class="relevant">rÃ©vÃ©lation</span>

::: {.fragment .fade-left}
L'importance d'une maquette pour : 
:::

::: {.fragment .fade-left}
- La conception de sa cuisine
- La rÃ©alisation de l'application Shiny
:::
:::
::::

## Pierrot

:::: {.columns}
::: {.column width="45%"}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::

::: {.column width="55%"}
### 2 ans aprÃ¨s... la suite

::: {.fragment .fade-left}
Suite Ã  sa visite dans cette grande enseigne suÃ©doise :

- Il a tout achetÃ© : les meubles, les outils, _etc..._
:::

::: {.fragment .fade-left}
La maquette est validÃ©e avec son client :

- Il est prÃªt Ã  se lancer dans le dev
:::
:::
::::

## Pierrot

:::: {.columns}
::: {.column width="45%"}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::

::: {.column width="55%"}
### Voici venu le temps de la <span class="relevant">production</span>

::: {.fragment .fade-left}
Pierrot va devoir monter sa cuisine :

- Assembler les meubles, fixer, visser, _etc..._
- Faire attention Ã  ne rien casser
:::

::: {.fragment .fade-left}
Et surtout :
:::

::: {.fragment .fade-left}
S'assurer une qualitÃ© de montage suffisante pour les annÃ©es Ã  venir
:::
:::
::::

# Il y a le plan de la maquette ...

# ... et la rÃ©alisation

## Pierrot

:::: {.columns}
::: {.column width="25%"}
:::

::: {.column width="75%"}
### Les craintes de Pierrot...

- Une cuisine mal montÃ©e,
- Une cuisine pas robuste,
- _etc..._
:::
::::

## Les craintes de Pierrot... 

::: {.r-stack}
![](assets/failed1.webp){.fragment width="650" height="600"}

![](assets/failed2.webp){.fragment width="650" height="600"}

![](assets/failed3.webp){.fragment width="650" height="600"}
:::

## Pierrot

:::: {.columns}
::: {.column width="25%"}
:::

::: {.column width="75%"}
### Que Pierrot soit rassurÃ©

Le vendeur lui assure que  :

- **Le matÃ©riel est testÃ©** : les vis, les placards, _etc..._ sont soumis Ã  des tests de charge

- **L'outil de conception** montre les erreurs Ã©ventuelles
:::
::::

## Pierrot

:::: {.columns}
::: {.column width="45%"}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::

::: {.column width="55%"}
### C'est une nouvelle <span class="relevant">rÃ©vÃ©lation</span>

::: {.fragment .fade-left}
Et si Pierrot utilisait des tests pour l'application Shiny de son client ?
:::

::: {.fragment .fade-left}
Faire des tests dans son application Shiny va lui permettre de : 

- Valider progressivement son code

- S'assurer de ne rien casser en modifiant et/ou en ajoutant du code

- Augmenter la robustesse de l'application
:::

:::
::::

# Les tests dans Shiny

# Les tests unitaires

_Comment s'assurer que chaque tiroir s'ouvre <br> correctement avant de l'installer dans la cuisine..._

## Les tests unitaires

:::: {.columns}
::: {.column width="45%"}
![](assets/unit_tests.png)
:::

::: {.column width="55%"}
### Tester un tiroir individuellement

Comme vÃ©rifier qu'un tiroir s'ouvre et se ferme correctement, les tests unitaires dans Shiny permettent de :

::: {.fragment .fade-left}
- VÃ©rifier qu'une fonction retourne la bonne valeur
- S'assurer que les erreurs sont correctement gÃ©rÃ©es
- Tester le comportement d'une fonction avec diffÃ©rents inputs
:::
:::
::::

## Les tests unitaires

:::: {.columns}
::: {.column width="45%"}
![](assets/testunitaire.png)
:::

::: {.column width="55%"}
### Tester un tiroir individuellement

Pierrot va tester les diffÃ©rentes sorties dâ€™une fonction, de maniÃ¨re indÃ©pendante des autres fonctions.
:::
::::

## Les tests unitaires

:::: {.columns}
::: {.column width="45%"}
![](assets/testunitaire.png)
:::

::: {.column width="55%"}
### La bonne nouvelle

Pierrot a suivi le tutoriel des <span class="relevant">#RR25</span> de lundi matin sur `{Golem}` ! 

Son application Shiny est donc un <span class="relevant">package</span>, ce qui va faciliter la crÃ©ation des tests unitaires.
:::
::::

## Les tests unitaires

:::: {.columns}
::: {.column width="45%"}
```
myShinyApp/
â”œâ”€â”€ DESCRIPTION
â”œâ”€â”€ NAMESPACE
â”œâ”€â”€ app.R
â”œâ”€â”€ R/
â”‚   â”œâ”€â”€ app_ui.R
â”‚   â”œâ”€â”€ app_server.R
â”‚   â””â”€â”€ run_app.R
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ testthat/
â”‚   â”‚   â”œâ”€â”€ test-calculate_average.R
â”‚   â”‚   â”œâ”€â”€ test-golem-recommended.R
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ testthat.R
```
:::

::: {.column width="55%"}
### CrÃ©er la structure de tests

Pour crÃ©er la structure de tests, Pierrot peut exÃ©cuter : 

- `golem::use_recommended_tests()`

- `usethis::use_test("calculate_average")`
:::
::::

## Les tests unitaires

:::: {.columns}
::: {.column width="45%"}
```{r}
#| eval: false
#| echo: true
calculate_average <- function(values) {
  if (!is.numeric(values)) {
    stop("values doit Ãªtre numÃ©rique")
  }
  if (length(values) == 0) {
    return(0)
  }
  sum(values) / length(values)
}
```
:::

::: {.column width="55%"}
```{r}
#| eval: false
#| echo: true
test_that("calculate_average fonctionne", {
  # Test avec des valeurs numÃ©riques
  expect_equal(
    object = calculate_average(c(10, 20, 30)), 
    expected = 20
  )
  
  # Test avec un vecteur vide
  expect_equal(
    object = calculate_average(numeric(0)), 
    expected = 0
  )
  
  # Test avec input non-numÃ©rique
  expect_error(
    object = calculate_average(c("a", "b")), 
    "values doit Ãªtre numÃ©rique"
  )
})
```
:::
::::

## Les tests unitaires

:::: {.columns}
::: {.column width="45%"}
![](assets/result_tests.png)
:::

::: {.column width="55%"}
### Un premier pas

Ici, Pierrot vient tester une fonction dans son application. 

::: {.fragment .fade-left}
En revanche, il ne vient pas tester directement son application, les intÃ©ractions, _etc..._
:::

::: {.fragment .fade-left}
Mais il vient de <span class="relevant">sÃ©curiser la logique mÃ©tier derriÃ¨re son application</span>. 
:::
:::
::::

# Les tests d'intÃ©gration

_Les meubles de cuisine sont testÃ©s individuellement, <br> mais comment savoir s'ils fonctionneront ensemble ?_

## Les tests d'intÃ©gration

:::: {.columns}
::: {.column width="45%"}
![](assets/inte_tests.png)
:::

::: {.column width="55%"}
### Assembler les meubles entre eux

Comme vÃ©rifier que la porte du frigo ne butte pas contre le mur, les tests d'intÃ©gration permettent de :

::: {.fragment .fade-left}
- Tester l'emboitement des fonctions

- S'assurer que les modules Shiny rÃ©agissent correctement

- VÃ©rifier le bon fonctionnement des flux rÃ©actifs
:::
:::
::::

## Les tests d'intÃ©gration

:::: {.columns}
::: {.column width="45%"}
\ 

\ 

![](assets/test_usage.png)
:::

::: {.column width="55%"}
### Assembler les meubles entre eux

Ã€ la diffÃ©rence des tests unitaires, Pierrot va tester les interactions entre les fonctions.
:::
::::

## Les tests d'intÃ©gration

:::: {.columns}
::: {.column width="45%"}
```{r}
#| eval: false
#| echo: true
app_ui <- function(request) {
  fluidPage(
    numericInput(
      inputId = "num1",
      label = "Premiere valeur",
      value = 10
    ),
    numericInput(
      inputId = "num2",
      label = "Seconde valeur",
      value = 10
    ),
    ...
    actionButton(
      inputId = "go",
      label = "Calculer !"
    )
  )
}
```
:::

::: {.column width="55%"}
![](assets/app_inte.png){width=80%}
:::
::::

## Les tests d'intÃ©gration

:::: {.columns}
::: {.column width="45%"}
```{r}
#| eval: false
#| echo: true
app_ui <- function(request) {
  fluidPage(
    numericInput(
      inputId = "num1",
      label = "Premiere valeur",
      value = 10
    ),
    numericInput(
      inputId = "num2",
      label = "Seconde valeur",
      value = 10
    ),
    ...
    actionButton(
      inputId = "go",
      label = "Calculer !"
    )
  )
}
```
:::

::: {.column width="55%"}
```{r}
#| eval: false
#| echo: true
app_server <- function(input, output, session) {

  rv <- reactiveValues()

  observeEvent(input$go, {
    rv$avg <- calculate_average(
      values = c(
        input$num1,
        input$num2,
        input$num3,
        input$num4
      )
    )
  })
}
```
:::
::::


## Les tests d'intÃ©gration

:::: {.columns}
::: {.column width="45%"}
```{r}
#| eval: false
#| echo: true
testServer(app_server, {
  session$setInputs(num1 = 5)
  session$setInputs(num2 = 5)
  session$setInputs(num3 = 5)
  session$setInputs(num4 = 5)
  session$setInputs(go = 1)

  expect_equal(
    object = rv$avg, 
    expected = 5
  )

  session$setInputs(num1 = 10)
  session$setInputs(num2 = 20)
  session$setInputs(num3 = 30)
  session$setInputs(num4 = 12)
  session$setInputs(go = 2)

  expect_equal(
    object = rv$avg,
    expected = 18
  )
})

```
:::

::: {.column width="55%"}
```{r}
#| eval: false
#| echo: true
app_server <- function(input, output, session) {

  rv <- reactiveValues()

  observeEvent(input$go, {
    rv$avg <- calculate_average(
      values = c(
        input$num1,
        input$num2,
        input$num3,
        input$num4
      )
    )
  })
}
```
:::
::::

## Les tests d'intÃ©gration

:::: {.columns}
::: {.column width="45%"}
![](assets/result_tests2.png)
:::

::: {.column width="55%"}
### Un second pas

Ici, Pierrot vient de tester les imbrications dans son application et notamment des interactions.

::: {.fragment .fade-left}
Il vient de <span class="relevant">sÃ©curiser le bon fonctionnement de son application</span>.
:::

::: {.fragment .fade-left}
En revanche, ces tests restent "_programmatique_" et ils ne simulent pas un vrai navigateur/utilisateur.
:::
:::
::::

# Les tests End-to-End

_Nos meubles s'assemblent bien en thÃ©orie, <br>mais comment savoir si la cuisine sera vraiment utilisable par Pierrot ?_

## Les tests End-to-End

:::: {.columns}
::: {.column width="45%"}
![](assets/e2e_tests.png)
:::

::: {.column width="55%"}
### Cuisiner un vrai repas

Comme cuisiner rÃ©ellement dans la cuisine pour s'assurer que tout est fonctionnel, les tests end-to-end permettent de :

::: {.fragment .fade-left}
- Simuler de vraies interactions utilisateur

- Tester l'application dans un vrai navigateur

- VÃ©rifier l'expÃ©rience utilisateur complÃ¨te
:::
:::
::::

## Les tests End-to-End

:::: {.columns}
::: {.column width="45%"}
![](assets/e2e_tests.png)
:::

::: {.column width="55%"}
### Simuler un utilisateur dans un navigateur

Pour tester l'application dans un vrai navigateur, Pierrot va utiliser la librairie JS <span class="relevant">Playwright</span>.

::: {.fragment .fade-left}
Mais Pierrot est dÃ©veloppeur R, il va donc utiliser le nouveau package R : `{pw}`

<a href="https://github.com/ThinkR-open/pw" target="_blank">ğŸ”— github.com/ThinkR-open/pw</a>
:::
:::
::::

## Les tests End-to-End

:::: {.columns}
::: {.column width="70%"}
![](assets/signature-r.png)
:::

::: {.column width="30%"}
### Simuler un utilisateur dans un navigateur 

<a href="https://connect.thinkr.fr/signature-r/" target="_blank">ğŸ”— thinkr.fr/signature-r</a>

::: {.fragment .fade-left}
`pw::pw_init()` pour initier la structure de tests pour <span class="relevant">Playwright</span>

Puis `devtools::test()` comme prÃ©cÃ©demment
:::
:::
::::


## Les tests End-to-End

:::: {.columns}
::: {.column width="70%"}
![](assets/tests_e2e.gif)
:::

::: {.column width="30%"}
### Simuler un utilisateur dans un navigateur

Ca va trÃ¨s vite ... mais Playwright lance dans un navigateur l'application et simule un comportement utilisateur.

Fonctionne pour plusieurs navigateurs : Chromium, Firefix et Webkit.
:::
::::


## Les tests End-to-End

:::: {.columns}
::: {.column width="70%"}
![](assets/tests_e2e-2.gif)
:::

::: {.column width="30%"}
### Simuler un utilisateur dans un navigateur

On peut ralentir les tests en mode "_trace_"
:::
::::

## Les tests End-to-End

:::: {.columns}
::: {.column width="70%"}
```{js}
#| eval: false
import { test, expect } from '@playwright/test';

test('Fill signature is working', async ({ page }) => {
  await page.goto('http://localhost:3000/');
  await expect(page.getByTestId("appName")).toBeVisible();

  await expect(page.getByTestId('firstname')).toBeVisible();
  await expect(page.getByPlaceholder('John')).toBeEmpty();
  await page.getByPlaceholder('John').click();
  await page.getByPlaceholder('John').fill('Arthur');
  await expect(page.getByTestId('signature-names')).toMatchAriaSnapshot(`- 'cell "Arthur {{lastname}}"'`);

  await page.getByPlaceholder('Doe').fill('BrÃ©ant');
  await expect(page.getByTestId('signature-names')).toMatchAriaSnapshot(`- 'cell "Arthur BrÃ©ant"'`);

  await page.getByRole('button', { name: 'copy fa-solid icon Copy to' }).click();
  await expect(page.getByText('Ã—Paste the signature in your')).toBeVisible();
});
```
:::

::: {.column width="30%"}
### Simuler un utilisateur dans un navigateur

Avantage : Playwright propose de gÃ©nÃ©rer le code automatiquement en cliquant dans l'application
:::
::::

## Les tests End-to-End

![](assets/e2e_generator.gif){width="100%"}

## Les tests End-to-End

:::: {.columns}
::: {.column width="45%"}
![](assets/result_tests3.png)
:::

::: {.column width="55%"}
### Un dernier pas

Ici, Pierrot vient de tester dans des conditions rÃ©elles son application.

::: {.fragment .fade-left}
Il vient de <span class="relevant">sÃ©curiser le bon fonctionnement de son application, tant sur la logique mÃ©tier que sur la partie UI</span>.
:::

::: {.fragment .fade-left}
Les tests End-to-End fonctionnent Ã©galement dans la CI pour assurer Ã  Pierrot un continuitÃ© dans son dÃ©veloppement.
:::
:::
::::

## Les tests dans Shiny

:::: {.columns}
::: {.column width="45%"}
![](assets/e2e_tests.png)
:::

::: {.column width="55%"}
### La cuisine parfaite de Pierrot


::: {.fragment .fade-left}
**Tests unitaires**

- Toutes les fonctions utilitaires et mÃ©tiers
:::

::: {.fragment .fade-left}
**Tests d'intÃ©gration**

- Flux rÃ©actifs principaux
:::

::: {.fragment .fade-left}
**Tests end-to-end**

- Parcours utilisateur critiques ou complexes
:::
:::
::::

## La cuisine de Pierrot

:::: {.columns}
::: {.column width="45%"}
::: {.fragment .fade-right}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::
:::

::: {.column width="55%"}
::: {.fragment .fade-left}
### Le rÃ©sultat final

GrÃ¢ce Ã  sa stratÃ©gie de tests Ã  trois niveaux :
:::

::: {.fragment .fade-left}
- Pierrot a livrÃ© une application robuste

- Son client est satisfait

- Les modifications futures seront plus sereines
:::

::: {.fragment .fade-left}
Et sa cuisine est parfaitement fonctionnelle !
:::
:::
::::

## La cuisine de Pierrot

:::: {.columns}
::: {.column width="45%"}
{{< quarto-lottie src=https://lottie.host/5f2ed099-4737-471d-a199-96b7786d7c88/JhebxcrsLV.json >}}
:::

::: {.column width="55%"}
### Merci
:::
::::